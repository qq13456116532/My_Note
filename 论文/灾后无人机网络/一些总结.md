无人机之间一般都是自由空间损耗模型，因为没有障碍

然后无人机和地面用户之间一般都是概率LOS链路，因为存在障碍。

回程速率这种基本就是要求总的接收速率要小于它而已，拿个自由空间通信模型然后推导一下最大值然后做个约束。

计算任务一般有个比特数大小，然后每个比特需要多少个周期数，这样计算出需要的总的周期数，然后无人机每个时刻提供一定量的周期数，也就是计算能力，用户本地每个时刻也有一定量的计算能力。

然后一般考虑无人机的飞行消耗，一般又都是忽略通信消耗，那就是只剩无人机那个时刻决定的飞行速度来决定那个时刻的飞行消耗。通信消耗好像一般是用户方面有传输功率发送到无人机，那就是说无人机是没有通信消耗的，除非多跳？但是好像也因为数量级可以忽略。然后计算消耗也可以算进去。

然后处理延迟呢，就是分为传输延迟和处理延迟，这两个是同步的。

很多多跳通信都是将一个子时隙分为多个部分，有收集、有计算、有传输给别人。

需要缓冲区？

总信道被划分为B个正交子信道，所有链路共享这些子信道

①在UE生成任务时，无人机可以评估是否需要使用多跳通信，或者直接卸载任务。这种情况无人机计算能力好像需要不同。
②采用缓冲区
③无人机直接决定部分自己卸载，部分多跳。
④分阶段，但是好像只有那种计算全在基站的才这样，否则有的无人机不需要转发啊。

关于计算资源好像有两种，一种就是任务总的需要的周期数在各设备都是相同的，另一种就是不同设备（无人机、地面用户）之间计算每个比特数的周期数是不同的。那区别就是这样了，一个$F_k$，一个$F_m$
![](images/Pasted%20image%2020240718164947.png)
![](images/Pasted%20image%2020240718165012.png)

然后处理一个任务的时间一般都是两者取最大值： 处理GD端任务的最大时间和传输任务的最大时间加上无人机端处理任务的总时间中取较大值

对于计算密集型应用（如图像识别和视频分析），输出数据的大小与输入数据的大小之比是很小的。所以一般都是忽略了将处理结果返回给MU的时延，我们认为系统时延由以下两个主要部分组成：
- **从MU到UAV/BS的传输时间**
- **UAV/BS计算时间**
同理下行数据的能耗也可以忽略


无人机的初始位置貌似可以通过聚类用户位置坐标来进行初始化？


无人机里面可能有任务队列，那么就会有队列积压，但是这种情况需要用户生成任务不能每个时刻都在生成，而是有一定的概率生成任务。那么队列的积压的变化公式就变成了：
![](images/Pasted%20image%2020240801213928.png)
$A_k$是在时刻$n$产生的任务，$l_k$是在时刻n执行的任务


关于多跳选择哪一条路径，一般都是使用有 **最XX** 的那条路径，比如现在看到的就是有 最长维持链路时间 的那个路径

多跳时同时刻的决策完全可以为了简化不考虑这时刻别人的影响。

把多跳过程当成  A->B 这样过程的多个递归过程。然后每个过程都可以计算这个过程的时延，就是A计算的时间，A排队的时间，传输的时间，B计算的时间，B排队的时间，为了简化考虑可以使用某些方式另类估计。然后 A-> 的时间是 $max{\{A计算+A排队，A传输\}}$
因为可以同时排队/计算和传输。
B的基本就是考虑另类计算方式。
然后里面选择B的过程就是会导致时延的变化，所以强化学习就在这里进行寻找

然后用户应该本身也包含任务队列，因为总归是无人机少而用户多，

R2X的代码里用了个动作掩码，用于最后判断是否设置为有效值，应该是不错的东西




- ~~**子时隙**：每个时间槽内划分为 $N$ 个子时隙，记作 $\{s_1, s_2, \dots, s_N\}$。卸载到其他无人机的任务本时间槽不计算，下个时间槽再计算。~~



将每架无人机的飞行子时隙 $t_{i,f}$ 和卸载子时隙 $t_{i,o}$ 看作是**动态优化的变量**，并且每架无人机都会根据其状态和任务进行独立的优化。这就意味着，每个时间槽中不同的无人机可能有不同的飞行和卸载时隙长度。

### 系统架构与符号定义
我在想是有可能考虑一下如何将全局奖励合理地分配给每个智能体的贡献


#### 1. **系统组成**
- **地面用户集**：设有 $U$ 个地面用户，记作集合 $\mathcal{U} = \{u_1, u_2, \dots, u_U\}$。
- **无人机集**：设有 $N$ 架无人机，记作集合 $\mathcal{N} = \{n_1, n_2, \dots, n_N\}$，在固定高度$h$飞行
- **时间槽**：系统按照离散的时间槽（time slots）进行操作，每个时间槽记为 $t \in \{1, 2, \dots\}$
- 时隙分为移动时隙和感知时隙和处理时隙，$t_m$ 和$t_s$ 和 $t_h$ ,$t_m$ 进行位置更新（移动），$t_s$ 时无人机从用户处接收任务（任务卸载）， $t_h$ 时无人机处理任务和进行多跳传输
#### 2.**链接**
- 无人机和无人机是LOS链接，因为可通信距离非常远，所以无人机之间一直可以互相通信，且通过固定的带宽$B_u$ 和固定的传输功率$P_u$，传输速率是 $$B_u\log_2\left(1+\frac{P_u}{\delta*d_{j,i}^2}\right)$$其中$\delta$ 代表路径损耗因子
- 无人机和用户间是PLOS链接，无人机有个感知范围 $R$，那么有$\sqrt{d_{i,u}^2+h^{2}}<=R$ ，然后计算LOS概率$$P_{\mathrm{LOS}}=\frac1{1+a\cdot\exp\left(-b\cdot(\arctan\left(\frac{h}{d_{i,u}}\right)-a_0)\right)}$$然后传输速率是$$R_{i,u}(t)=B\log_2\left(1+\frac{P_{\mathrm{LOS}}\cdot h_{\mathrm{LOS}}(t)+(1-P_{\mathrm{LOS}})\cdot h_{\mathrm{NLOS}}(t)}{N_0}\right)$$

#### 3. **任务生成**
- **任务量**：每个用户 $u \in \mathcal{U}$ 在时间槽 $t$ 以概率 $p_u$ 生成的随机大小任务数据量记作 $T_u(t)$。任务不需要（暂时不考虑）在一定的时间约束下完成计算。
- 用户 $u$ 在时间槽 $t$ 时生成的任务量为 $T_u(t)$，会立即加入任务队列。则用户的任务队列更新规则为：$$Q_{u}(t)= Q_u(t-1)+T_u(t)$$ 如果用户有任务被卸载到无人机上，任务队列相应减少
$$Q_u(t)=Q_u(t-1)+T_u(t)-T_{u,i}(t)$$

#### 4. **无人机移动和卸载**
- **无人机移动**：无人机在时间槽开始选择移动方向，速度固定为$v$，最大移动距离是 $D = v*t_m$ 
- **任务卸载**：在时间槽 $t$ 内的任务卸载时隙 $t_s$ ，~~任务卸载时隙又分为$K$个部分$\delta_k[t]$，每个部分无人机选择分给自己感知范围内的任意一个用户，无人机选择一个在范围内的用户进行数据卸载~~，**我想在这里简化为在这个时刻只选择其覆盖范围内信号质量最好的GU关联**，无人机 $i$ 从用户 $u$ 接收到的任务卸载量为 $T_{u,i}(t)$ 。无人机感知总任务量是 $$T_i(t)+=\sum\limits_uT_{u,i}(t)$$
关于无人机带宽是固定为$B_i$。
#### 5. **无人机计算与多跳**
- **无人机的计算能力**：每架无人机 $i \in \mathcal{N}$ 的计算能力记为 $C_i$
- **任务计算量**：无人机 $i$ 在感知阶段从用户接收到的总的任务卸载量为 $T_i(t)$，无人机决定多少比例 $\rho_i$ 自己计算，$1-\rho_i$ 多跳给别人。
- **任务计算时延**：无人机 $i$ 计算任务 $T_i(t)$ 所需的计算时间可以表示为： $$D_{local}(T_i(t)) = \frac{\rho_i T_i(t) \cdot \kappa}{C_i}$$其中，$\kappa$ 是任务计算所需的CPU周期与比特量之间的转换因子。
-  **卸载任务速率**：设 $B$ 为信道带宽，$h_{i,j}(t)$ 为无人机 $i$ 和 $j$ 之间的信道增益，无人机 $i$ 在子时隙 $t_h$ 内和无人机 $j$ 之间的传输速率为： $$R_{i,j}(t) = B \log_2 \left( 1 + \frac{P_i \cdot h_{i,j}(t)}{N_0} \right)$$其中，$P_i$ 为无人机 $i$ 的传输功率，$N_0$ 为噪声功率谱密度，$h_{i,j} = \frac{1}{\delta d_{i,j}^2}$
- **多跳时延**： 任务可以在无人机之间无限多跳，对于每一跳，
传输时延都是$$D_{\text{transmission,}k}=\frac{(1-\rho_{k-1})T_{\text{offload,}k-1}}{R_{k-1,k}}$$排队时延都是$$D_{\text{queue,}k}=\frac{Q_k(t-1)+\rho_k(t)T_k(t)+\sum\limits_{i \notin k}T_{{offload},i,k}}{C_k/\kappa}$$处理时延都是$$D_{\text{processing,}k}=\frac{\rho_k(1-\rho_{k-1})T_{\text{offload,}k-1}\cdot\kappa}{C_k}$$或是$$D_{\text{processing,}k}=\frac{\rho_k\cdot T_{\text{i}}(t)\cdot\prod_{i=1}^{k-1}(1-\rho_i)\cdot}{C_k/\kappa}$$，将以上各项带入，总时延是$$D_{total}=\sum\limits_T\sum\limits_{k}(D_{\text{transmission,}k}+D_{\text{queue,}k}+D_{\text{processing,}k})$$
为了简化，我们假设任务在各跳之间的处理是顺序的，即下一跳的处理在上一跳处理完成后才开始。这种保守估计会得到总时延的上界，在实际中，需要使用估计的最大时延来安排下一步的行动，所以这是合理的。

#### 6. **能量消耗**
在移动时隙 $t_m$ ，无人机的旋翼功率消耗是$P_{UAV}$ ，只是固定速度 $v$ 的公式，移动能量消耗是 $E_{mobile}=P_{UAV}*t_m$
在感知时隙 $t_s$ ，用户是发送端，无人机是接收端。无人机的接收能量消耗通常较小，所以忽略，不需要考虑用户设备的能量消耗。
在处理时隙 $t_h$ ，对于每一跳，
- 通信能量消耗分为接收能量消耗（一般情况下，接收能量消耗可以忽略不计），和传输能量消耗：$$E_{\text{transmission,}k}=P_{k,k+1}\cdot D_{\text{transmission,}k+1}$$
- 计算能量消耗都是 $$E_{\text{compute,}k}=\kappa\rho_kT_kf_k^2$$，其中，$f_k$ 是无人机 $k$ 的 CPU 频率，$\kappa$ 是计算能量系数。
处理时隙的总能量消耗是$$E_{total}=\sum\limits_T\sum\limits_k(E_{\text{transmission,}k}+E_{\text{compute,}k})$$

#### 7. **跳数确认**
由于任务量在每一跳都会按照 $(1 - \rho_k)$ 的比例减少，如果所有 $\rho_k > 0$ ，则$$\lim_{k\to\infty}T_{\text{offload},k}=T_{\text{initial}}\cdot\lim_{k\to\infty}\prod_{i=1}^k(1-\rho_i)=0$$意味着任务量在无限多跳后会趋近于零，即任务最终会被完全处理。
**因此，总时延和总能量消耗的级数会收敛。**

但是实际计算中无法处理无限项的求和，我们可以考虑到当任务量降至可忽略的程度后，后续的时延和能量消耗可以忽略，也就是当$T_{\text{offload},k}$小于某个阈值时停止计算，也就是找到一个最小的整数$K$，使得：$$T_{\text{offload},K}=T_{\text{initial}}\cdot\prod_{i=1}^K(1-\rho_i)<\varepsilon $$在 $k = 1$ 到 $K$ 之间求和，得到总时延和能量消耗的近似值。


#### 8. **系统优化目标**
总的时延最小化和总的能量消耗最小化

目标就是 $$min_{V} \alpha * 总时延 + \beta * 总能量消耗$$
优化变量是
- 在时间槽 $t$ 时无人机 $u$ 的轨迹$p_u[t]$，
- 无人机如何分配$\delta_u[t]$ ,即K个子子时隙分别分给哪个用户，
- 决定无人机自己计算和通过多跳传输任务的比例的 $0<=\rho<=1$，和下一跳的无人机。其他任务与自身的任务一起考虑，在同一个时间槽内按照相同的任务处理比例 𝜌进行分配。
有坐标约束 $\|p_u[t+1]-p_u[t]\|\leq D$
有时间约束 $\sum_{k}\delta_k[t]\le t_s$


-----------------------------------------------------------------

 ```ad-danger
注意这里的Little法是很不合理的，使用M/M/1队列模型代替。
```

下面是前面5的备份：
#### 5. **无人机计算与多跳**
- **无人机的计算能力**：每架无人机 $n_i \in \mathcal{N}$ 的计算能力记为 $C_i$
- **任务计算量**：无人机 $n_i$ 从用户接收到的任务卸载量为 $T_{u,i}(t)$，无人机决定多少比例 $\rho$ 自己计算，$1-\rho$ 多跳给别人。
- **任务计算时延**：无人机 $n_i$ 计算任务 $T_{u,i}(t)$ 所需的计算时间可以表示为： $$D_i(T_{u,i}(t)) = \frac{\rho T_{u,i}(t) \cdot \kappa}{C_i}$$其中，$\kappa$ 是任务计算所需的CPU周期与比特量之间的转换因子。
-  **卸载的任务量限制**：由于无线信道带宽的限制，卸载任务的总量需要受到信道容量的约束。设 $B$ 为信道带宽，$h_{i,j}(t)$ 为无人机 $n_i$ 和 $n_j$ 之间的信道增益，无人机 $n_i$ 在子时隙 $s_i$ 内卸载给无人机 $n_j$ 的任务数据速率为： $$R_{i,j}(t) = B \log_2 \left( 1 + \frac{P_i \cdot h_{i,j}(t)}{N_0} \right)$$其中，$P_i$ 为无人机 $n_i$ 的传输功率，$N_0$ 为噪声功率谱密度。
- **多跳时延**： 这里应该是传输时延加计算时延，前者就是$\frac{(1-\rho)*T_{u,i}(t)}{R_{i,j}(t)}$ ，后者是排队时延加计算时延，排队时延使用队列模型中的 Little 法则来近似计算，计算时延就直接计算$\frac{(1-\rho)T_{u,i}(t)}{C_j}$。

- **Little法则**：设无人机 $n_i$ 在时间槽 $t$ 的任务队列长度为 $Q_i(t)$，其平均排队时延可以用队列模型中的 Little 法则来近似计算：
$$W_j(t) = \frac{Q_j(t)}{C_j \cdot t_h}$$
其中，$C_i​$为无人机的计算能力，$t_h$ 为计算时隙的时长。
- **这部分的总时延：** 这部分本地计算和多跳是可以异步进行的，所以是取 $max( \frac{\rho T_{u,i}(t) \cdot \kappa}{C_i}，\frac{(1-\rho)*T_{u,i}(t)}{R_{i,j}(t)} + W_{j(t)} + \frac{(1-\rho)T_{u,i}(t)}{C_j})$

- 这里应该是传输时延加计算时延，前者就是$\frac{(1-\rho)*T_{u,i}(t)}{R_{i,j}(t)}$ ，后者是排队时延$W_j$加计算时延，计算时延就直接计算$\frac{(1-\rho)T_{u,i}(t)}{C_j}$。
- **这部分的总时延：** 这部分本地计算和多跳是可以异步进行的，所以是取 $max( \frac{\rho T_{u,i}(t) \cdot \kappa}{C_i}，\frac{(1-\rho)*T_{u,i}(t)}{R_{i,j}(t)} + W_{j(t)} + \frac{(1-\rho)T_{u,i}(t)}{C_j})$














